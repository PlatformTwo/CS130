<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>JS Webinar Chat</title>
    <meta name="description" content="JS Webinar Chat">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Gorditas:700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="modal fade" id="profile-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Welcome, please let us know who you are:</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <label for="txtUsername">User Name:</label>
                            <input type="text" id="txtUsername">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <label for="txtLocation"><p>Where are you from:</p></label>
                            <input type="text" id="txtLocation">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="btn-update-profile">Save changes</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <section id="main" role="main">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 well well-lg" style="background-color: #708090">
                    <div class="row">
                        <div class="col-sm-12">
                            <button type="button" class="btn btn-default btn-sm" style="position: relative; top: -5px;left:12px; float:right" id="join-button">
                                <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" style="position: relative; top: -5px;left:12px; float:right" id="leave-button">
                                <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" style="position: relative; top: -5px;left:12px; float:right" id="settings-button" data-toggle="modal" data-target="#profile-modal">
                                <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4" style="position: relative;left: -3px;display:block">
                            <div class="row">
                                <div id="user-count-container" class="well col-sm-12">
                                    <p id="presence"><span class="badge"></span></p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="well col-sm-12" style="height:546px;padding: 18px">
                                    <ul id="userl" class="list-group">
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8" id="message-area">
                            <div class="row well">
                                <div id="chat-output" class="col-sm-12">
                                    <ul id="chat-messages" class="list-group">
                                    </ul>
                                </div>
                            </div>
                            <div class="row well">
                                <div id="chat-control" class="col-sm-8">
                                    <div class="message-console-send-area" class="col-sm-10">
                                        <label class="message-console-textarea-title" for="message-console-input">message</label>
                                        <textarea class="console-message" id="console-message-input" placeholder="Your message....."></textarea>
                                    </div>
                                    <div class="col-sm-4">
                                        <button type="button" class="btn btn-default btn-lg" id="send-button">
                                            <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </section>
    <footer></footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.1.1.js"></script>
    <script src="js/app.js"></script>
    <script>
        (function() {
            // bind the Enter key to send-button click event
            $(document).keypress(function(e){
                if (e.which == 13){
                    $("#send-button").click();
                }
            });

            //Init & Subscribe
            var chat_channel = "webinar-chat1";
            var pubkey = "demo-36"; // use your own pub-key
            var subkey = "demo-36"; // use your own sub-key
            var avatarClassName = 'face-' + ((Math.random() * 13 + 1) >>> 0) + ' color-' + ((Math.random() * 10 + 1) >>> 0);

            var username = "Unknown";
            var city = "Unknown";
            var country = "USA";

            var myState = {
                'username': username,
                'avatar': avatarClassName,
                'location': 'Uknown'
            };

            if (localStorage.getItem('profileExists')) {
                //initalize the userState from localstorage..
                //you could also retrieve a user profile from your backend systems
                myState.username = localStorage.profileUserName;
                myState.avatar = localStorage.profileAvatarClassName;
                myState.location = localStorage.profileLocation;
            }

            var myUUID = localStorage.getItem(subkey + "uuid");
            var lastTimeToken = localStorage.getItem(subkey);

            console.log('local storage had: ' + myUUID + ' for uuid and ' + ' ' + lastTimeToken);

            if (lastTimeToken === null) {
                console.log('not using last token');
                lastTimeToken = 0; //make it zero
            }

            if (myUUID === null) {
                myUUID = PubNub.generateUUID();
            }

            var pubnub = new PubNub({
                subscribeKey: pubkey,
                publishKey:   subkey,
                logVerbosity: false,
                uuid:         myUUID,
                ssl:          true,
                heartbeatInterval: 60
            });

            pubnub.addListener({
                message: function(event) {
                    lastTimeToken = event.timetoken;
                    var formattedTime = UI.formatTimeToken(lastTimeToken);
                    var text = event.message.text;
                    var fromUser = event.message.from;
                    var avatar = event.message.avatar;

                    UI.addChatMessage(text, formattedTime, fromUser, avatar);
                },

                presence: function(event) {
                    var action = event.action;
                    var channel = event.channel;
                    var uuid = event.uuid;
                    var data = event.state;
                    var occupancy = event.occupancy;

                    console.log("");
                    console.log("*** presence event ***");
                    console.log("action:    " + action);
                    console.log("channel:   " + channel);
                    console.log("uuid:      " + uuid);
                    console.log("occupancy: " + occupancy);
                    console.log("data:      " + JSON.stringify(data));
                    console.log("*** presence event ***");
                    console.log("");

                    if (action === "state-change") {
                        console.log("!!!@@@ state-change event @@@!!!");
                        UI.handleStateChange(action, uuid, data);
                    } 
                    else if (action === "join") {
                        //get the state of the user
                        pubnub.getState(
                            {
                                channel: chat_channel,
                                uuid: uuid
                            },
                            function(status, response) {
                                console.log("!!! getState on join event !!!");
                                console.log("!!! getState status: " + JSON.stringify(status));
                                console.log("!!! getState response: " + JSON.stringify(response));    
                                UI.handleStateChange('state-change', uuid, response);
                            }
                        );

                        UI.updateRoomCount(action, occupancy);
                    } 
                    else if ((action === "timeout") || (action === "leave")) {
                        UI.handleLeaveEvent(action, uuid); 
                        UI.updateRoomCount(action, occupancy);
                    }
                },

                status: function(event) {
                    if (event.category === "PNConnectedCategory") {
                        pubnub.hereNow(
                            {
                                channels: [chat_channel],
                                includeUUIDs: true,
                                includeState: true
                            }, 
                            function (status, response) {
                                sendStateUpdate();

                                // only one channel for this app, so we don't need to iterate over channels
                                // get the channel by name and then get the uuids and state for each occupant
                                response['channels'][chat_channel]['occupants'].forEach(
                                    function(item) {
                                        if (item.state)
                                            UI.handleStateChange('state-change', item.uuid, item.state);
                                    }
                                );
                            }
                        );

                        // just get us last 100 messages
                        // but you could just get messages since
                        // last time you received a message
                        // or just get last 5 minutes of messages
                        pubnub.history(
                            {
                                channel: chat_channel,
                                includeTimetoken: true,
                                count: 100 // the default
                            },
                            function (status, response) {
                                response['messages'].forEach(
                                    function(msg) {
                                        UI.addChatMessage(
                                            msg.entry.text, 
                                            UI.formatTimeToken(msg.timetoken), 
                                            msg.entry.from, msg.entry.avatar
                                        );
                                    }
                                );
                            }
                        );
                    }
                    else if (event.category === "PNUnsubscribeOperation") {
                        UI.handleLeaveEvent("leave", myUUID);
                    }

                },
            });


            pubnub.subscribe({
                channels: [chat_channel],
                withPresence: true // also subscribe to presence instances.
            });

            function joinChatRoom() {
                // if (chat_channel != "webinar-chat") debugger;
                console.log("!!!! CHAT_CHANNEL: " + chat_channel);
                pubnub.subscribe({
                    channels: [chat_channel],
                    withPresence: true // also subscribe to presence instances.
                });
            }

            function leaveChatRoom() {
                pubnub.unsubscribe({
                    channels: [chat_channel]
                });
            }

            function sendStateUpdate() {
                var txtUserName = document.querySelector('#txtUsername');
                var txtLocation = document.querySelector('#txtLocation');

                myState.username = txtUsername.value;
                myState.location = txtLocation.value

                localStorage.setItem('profileUserName', txtUserName.value);
                localStorage.setItem('profileLocation', txtLocation.value);
                localStorage.setItem('profileAvatarClassName', avatarClassName);
                localStorage.setItem('profileExists', true);

                pubnub.setState(
                    {
                        channels: [chat_channel],
                        uuid: myUUID,
                        state: myState
                    },
                    function(response) {
                        console.log("setState on sendStateUpdate: " + JSON.stringify(response));
                    }
                );
            }

            var updateProfileButton = document.querySelector('#btn-update-profile');
            updateProfileButton.onclick = sendStateUpdate;

            if (myState.username === 'Unknow') {
                // userhas not set his state.
                $('#profile-modal').modal('show');
            } 
            else {
                var txtUserName = document.querySelector('#txtUsername');
                var txtLocation = document.querySelector('#txtLocation');
                txtUsername.value = myState.username;
                txtLocation.value = myState.location;

                pubnub.setState(
                    {
                        channels: [chat_channel],
                        uuid: myUUID,
                        state: myState
                    },
                    function(response) {
                        console.log("setState before joinChatRoom: " + JSON.stringify(response));
                        joinChatRoom();
                    }
                );
            }


            /** 
             * this function publishes the text in the input text to pubnub, anyone subscribed to the channel will recieve 
             * the message
             **/
            function publish() {
                var messageText = document.querySelector("#console-message-input");
                var msg = {
                    from: myState.username,
                    avatar: myState.avatar,
                    text: messageText.value
                };

                pubnub.publish(
                    {
                        message: msg,
                        channel: chat_channel
                    }, 
                    function (status, response) {
                        if (status.error) {
                            console.log(status)
                        } 
                        else {
                            console.log("message Published w/ timetoken", response.timetoken)
                        }
                    }
                );

                messageText.value = '';
            }

            //reference to the send button element
            var messageSend = document.querySelector("#send-button");
            messageSend.onclick = publish;
            
            joinButton = document.querySelector('#join-button');
            joinButton.onclick = joinChatRoom;

            leaveButton = document.querySelector('#leave-button');
            leaveButton.onclick = leaveChatRoom;
        })()
    </script>
</body>
</html>